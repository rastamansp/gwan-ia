version: '3.8'

services:
  gwan-site:
    image: gwan-site:latest
    container_name: gwan-site
    restart: unless-stopped
    networks:
      - gwan
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gwan-site.rule=Host(`gwan.com.br`)"
      - "traefik.http.routers.gwan-site.entrypoints=websecure"
      - "traefik.http.routers.gwan-site.tls.certresolver=letsencrypt"
      - "traefik.http.services.gwan-site.loadbalancer.server.port=80"
      - "traefik.docker.network=gwan"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      # Ambiente
      - NODE_ENV=production
      
      # Aplicação
      - VITE_APP_NAME=${VITE_APP_NAME:-Gwan IA}
      - VITE_APP_VERSION=${VITE_APP_VERSION:-1.0.0}
      
      # API
      - VITE_API_URL=${VITE_API_URL:-https://api.gwan.com.br/api}
      
      # SMTP
      - VITE_SMTP_HOST=${VITE_SMTP_HOST:-smtp.gmail.com}
      - VITE_SMTP_PORT=${VITE_SMTP_PORT:-587}
      - VITE_SMTP_SECURE=${VITE_SMTP_SECURE:-false}
      - VITE_SMTP_USER=${VITE_SMTP_USER:-}
      - VITE_SMTP_PASSWORD=${VITE_SMTP_PASSWORD:-}
      - VITE_SMTP_FROM_NAME=${VITE_SMTP_FROM_NAME:-GWAN}
      - VITE_SMTP_FROM_EMAIL=${VITE_SMTP_FROM_EMAIL:-noreply@gwan.com.br}
      
      # Admin
      - VITE_ADMIN_EMAIL=${VITE_ADMIN_EMAIL:-admin@gwan.com.br}
      - VITE_ADMIN_PASSWORD=${VITE_ADMIN_PASSWORD:-}
      - VITE_ADMIN_NAME=${VITE_ADMIN_NAME:-Administrador Gwan}
      
      # Chatwoot
      - VITE_CHATWOOT_KEY=${VITE_CHATWOOT_KEY:-}
      
      # Build
      - VITE_BUILD_TIME=${VITE_BUILD_TIME:-}
      - VITE_GIT_COMMIT=${VITE_GIT_COMMIT:-}
      - VITE_GIT_BRANCH=${VITE_GIT_BRANCH:-}
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

networks:
  gwan:
    external: true
